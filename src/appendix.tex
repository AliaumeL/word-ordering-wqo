% LTeX: language=en-GB 
% !TeX root=../wqo-on-words.lncs.tex

\clearpage
\section{Proofs for Section~\ref{introduction:sec}}

\begin{figure}
    \centering
    \begin{subfigure}[t]{0.48\textwidth}
    	\centering
    	\includestandalone[width=\linewidth]{fig/prefix-embedding-standalone}
    	\caption{Prefix Relation}
   	\end{subfigure}%
   	\hfill%
   	\begin{subfigure}[t]{0.48\textwidth}
   		\centering
   		\includestandalone[width=\linewidth]{fig/infix-embedding-standalone}
   		\caption{Infix Relation}
   	\end{subfigure}
   	\begin{subfigure}[t]{0.48\textwidth}
   		\centering
   		\includestandalone[width=\linewidth]{fig/subword-embedding-standalone}
   		\caption{Subword Relation}
   	\end{subfigure}
   	
   	\caption{A simple representation of the \kl{subword relation},
        \kl{prefix relation},
        and \kl{infix relation},
        on the alphabet $\set{a,b}$ for words of
        length at most $3$. The figures are Hasse Diagrams,
        representing the successor relation of the order.
        Furthermore, we highlight in dashed red relations that are added
        when moving from the prefix relation to the infix one,
        and to the infix relation to the subword one.}
    \label{word-embeddings:fig}
\end{figure}


\clearpage
\section{Proofs for Section~\ref{prefixes:sec}}

\begin{figure}
    \centering
    \includestandalone{fig/antichain-branch-standalone}
    \caption{An \kl{antichain branch} for the language $a^* b$,
        represented in the \kl{tree of prefixes} over the alphabet $\set{a,b}$.
        The branch is represented with dashed lines in turquoise, and the
        \kl{antichain} is represented in dotted lines in blood-red.
    }
    \label{antichain-branch:fig}
\end{figure}


\begin{proofof}{antichain-branches-prefix:lem}
    Assume that $L$ contains an \kl{antichain branch}. Let us construct an
    infinite \kl{antichain} as follows. We start with a set $A_0 \defined
    \emptyset$ and a node $v_0$ at the root of the tree. At step $i$, we
    consider a word $w_i$ such that $v_i$ is a \kl{prefix} of $w_i$, and $w_i
    \in L \setminus B$, which exists by definition of \kl{antichain branches}.
    We then set $A_{i+1} \defined A_i \cup \set{w_i}$. To compute $v_{i+1}$, we
    consider the largest prefix of $w_i$ that belongs to $B$, and set $v_{i+1}$
    to be the successor of this prefix in $B$. By an immediate induction, we
    conclude that for all $i \in \Nat$, $A_i$ is an \kl{antichain}, and that
    $v_i$ is a node in the \kl{antichain branch} $B$ such that $v_i$ is not a
    prefix of any word in $A_i$. 

    Conversely, assume that $L$ contains an infinite \kl{antichain} $A$. Let us
    construct an \kl{antichain branch}. Let us consider the subtree of the
    \kl{tree of prefixes} that consists in words that are \kl{prefixes} of
    words in $A$. This subtree is infinite, and by KÃ¶nig's lemma, it contains
    an infinite branch. By definition this is an \kl{antichain branch}.
\end{proofof}


\begin{proofof}{prefix-wqo-reg-decidable:cor}
	If $L$ is regular, then it is $\MSO$-definable, and there 
	exists a formula $\varphi(x)$ in $\MSO$ that selects nodes 
	of the \kl{tree of prefixes} that belong to $L$. Now, to decide whether there
	exists an \kl{antichain branch} for $L$, we can simply check whether
	the following formula is satisfied:
	\begin{equation*}
		\exists B. 
		B \text{ is a branch } \land
		\forall x \in B, \exists y. y \text{ is a child of } x \land \varphi(y) \land y \not\in B
		\quad .
	\end{equation*}
	Because the above formula is an $\MSO$-formula over the infinite
	$\Sigma$-branching tree, whether it is satisfied is decidable
	as an easy consequence of the decidability of $\MSO$ over infinite binary
	trees
	\cite[Theorem 1.1]{RAB69}.
\end{proofof}


\begin{proofof}{prefixes:thm}
    Assume that $L$ is a finite union of \kl{chains}.
    Because the \kl{prefix relation} is \kl{well-founded},
    and that finite unions of \kl{chains} have finite \kl{antichains},
    we conclude that $L$ is \kl{well-quasi-ordered}.
    
    Conversely, assume that $L$ is \kl{well-quasi-ordered} by the \kl{prefix
    relation}. Let us define $S_{\mathrm{split}}$ the set of words $w \in \Sigma^*$ 
    such that there exists
    two words $wu$ and $wv$ both in $L$ that are not comparable for the
    \kl{prefix relation}. Let $S = S_{\mathrm{split}}~\cup~\min_{\prefleq} L$
    Assume by contradiction that $S$ is infinite.
    Then, $S$ equipped with the \kl{prefix relation} is an infinite
    tree with finite branching, and therefore contains an infinite
    branch, which is by definition an \kl{antichain branch} for $L$.
    This contradicts the assumption that $L$ is \kl{well-quasi-ordered}.
    
    Now, let $w$ be a maximal element for the \kl{prefix ordering}
    in $S$. 
    The upward closure of $w$ in $L$, $(\upset[\prefleq]{w}) \cap L$, must be a 
    finite union of \kl{chains}. Otherwise at least two of the chains would share a common 
    prefix in $w\Sigma$, contradicting the maximality of $w$.
    
    In particular, letting $S_{\max}$ be the set of all maximal elements
    of $S$,
    we conclude that 
    \begin{equation*}
        L \subseteq S \cup \bigcup_{w \in S_{\max}} (\upset[\prefleq]{w}) \cap L
        \quad .
    \end{equation*}
    Hence, that $L$ is finite union of \kl{chains}.
\end{proofof}

\begin{proofof}{prefix-wqo-reg-decidable:cor}
    If $L$ is regular, then it is $\MSO$-definable, and there 
    exists a formula $\varphi(x)$ in $\MSO$ that selects nodes 
    of the \kl{tree of prefixes} that belong to $L$. Now, to decide whether there
    exists an \kl{antichain branch} for $L$, we can simply check whether
    the following formula is satisfied:
    \begin{equation*}
        \exists B. 
        B \text{ is a branch } \land
        \forall x \in B, \exists y. y \text{ is a child of } x \land \varphi(y) \land y \not\in B
        \quad .
    \end{equation*}
    Because the above formula is an $\MSO$-formula over the infinite
    $\Sigma$-branching tree, whether it is satisfied is decidable
    as an easy consequence of the decidability of $\MSO$ over infinite binary
    trees
    \cite[Theorem 1.1]{RAB69}.
\end{proofof}

\clearpage
\section{Proofs for Section~\ref{infixes-bounded:sec}}

\begin{figure}
    \centering
    \includestandalone[width=\linewidth]{fig/infix-encoding-standalone}
    \caption{Representation of the \kl{subword relation} for $\set{a,b}^*$
        inside the \kl{infix relation} for $\set{a,b,\#}^*$
        using a simplified version of \cref{infix-embedding:thm}, restricted to words
        of length at most $3$. 
    }
    \label{infix-embedding:fig}
\end{figure}


\begin{proofof}{inf-period-chain:lem}
    Let $x \in \Sigma^+$ be a word, and let $P_x$ be the (finite) set 
    of all \kl{prefixes} of $x$, and $S_x$ be the (finite)
    set of all \kl{suffixes} of $x$.
    Assume that $w \in \InfPeriodChain{x}$, then $w = u x^p v$ for some
    $u \in S_x$, $v \in P_x$, and $p \in \Nat$.
    We have proven that
    \begin{equation*}
        \InfPeriodChain{x} \subseteq \bigcup_{u \in P_x} \bigcup_{v \in S_x} u x^* v
        \quad .
    \end{equation*}

    Let us now demonstrate that for all $(u,v) \in S_x \times P_x$, the
    language $u x^* v$ is a \kl{chain} for the \kl{infix}, \kl{suffix} and \kl{prefix} relations.
    To that end,
    let $(u,v) \in S_x \times P_x$ and $\ell, k \in \Nat$ be such that $\ell <
    k$, let us prove that $u x^\ell v \infleq u x^k  v$. Because $v \prefleq
    x$, we know that there exists $w$ such that $vw = x$. In particular,
    $ux^\ell vw = u x^{\ell + 1}$, and because $\ell < k$, we conclude that $u
    x^{\ell + 1} \prefleq u x^k v$. By transitivity, $u x^\ell v \prefleq u x^k
    v$, and \emph{a fortiori}, $u x^\ell v \infleq u x^k v$. 
    Similarly, because $u \suffleq x$,  there exists $w$ such that $wu  = x$, 
    and we conclude that $u x^{\ell} v \suffleq w u x^\ell v = x^{\ell + 1} v \suffleq u x^k v$.
\end{proofof}


\begin{proofof}{pumping-periods:lem}
    Note that the result is obvious if $k = 0$, and therefore
    we assume $k \geq 1$ in the following proof.

    Let us construct a sequence of words $\seqof{w_i}[i \in \Nat]$, where $w_i
    \defined w[\vec{n_i}]$ for some well-chosen indices $\vec{n_i} \in \Nat^k$.
    The goal being that if $w[\vec{n_i}]$ is an \kl{infix} of $w[\vec{n_j}]$,
    then it can intersect at most \emph{two} iterated words, with an
    intersection that is long enough to successfully apply
    \cref{periodic-gcd:lem}. In order to achieve this, let us first define $s$
    as the maximal size of a word $v_i$ ($1 \leq i \leq k$) and $u_j$ ($1 \leq
    j \leq k+1$). Then, we consider $\vec{n_0} \in \Nat^k$ such that
    $\vec{n_0}$ has all its components greater than $\factorial{s}$ and such
    that $w[\vec{n_0}]$ belongs to $L$. Then, we inductively define
    $\vec{n_{i+1}}$  as the smallest vector of numbers greater than
    $\vec{n_i}$, such that $w[\vec{n_{i+1}}]$ belongs to $L$, and with
    $\vec{n_i}$ having all components greater than $2\card{w[\vec{n_i}]}$.

    Let us assume that $k \geq 2$ in the following proof for symmetry purposes,
    and argue later on that when $k = 1$ the same argument goes through.
    Because $L$ is \kl{well-quasi-ordered} by the \kl{infix relation}, there
    exists $i < j$ such that $w[\vec{n_i}]$ is an \kl{infix} of $w[\vec{n_j}]$.
    Now, because of the chosen values for $\vec{n_j}$, there exists $1 \leq \ell \leq
    k-1$ such that
    one of the three following equations holds:
    \begin{itemize}
        \item $w[\vec{n_i}] \infleq v_{\ell}^{n_{j,\ell}} u_{\ell+1} v_{\ell+1}^{n_{j,\ell+1}}$,
        \item $w[\vec{n_i}] \infleq u_{\ell}
            v_{\ell}^{n_{j,\ell}}$,
        \item $w[\vec{n_i}] \infleq
            v_{\ell}^{n_{j,\ell}} u_{\ell+1}$.
    \end{itemize}

    In the sake of simplicity, we will only consider one of the three cases,
    namely $w[\vec{n_i}] \infleq v_{\ell}^{n_{j,\ell}} u_{\ell+1}$, the other
    two being similar. Because the lengths used in $\vec{n_i}$ are all
    sufficiently large, we know that for every $k$, $v_k^{n_{i,k}}$ is an infix
    of a $v_{\ell}^p$ for some non-zero $p$. Therefore, we can apply
    \cref{periodic-gcd:lem} to conclude that there exists a word $x$ such that
    every $v_k$ is a power of a conjugate of $x$ (a cyclic shift of $x$), and
    $v_\ell$ is a power of $x$. We can therefore rewrite $w[\vec{n_i}]$ as $u_1
    (\sigma_1(x))^{n_{i,1}} u_2 \cdots $, where $\sigma_k$ is some conjugacy
    operation (cyclic shift). Now, in order for $w[\vec{n_i}]$ to be an infix
    of $x^{p \times n_{j,\ell}} u_{\ell+1}$, we must conclude that all the
    $u_k$'s are suffixes or prefixes of $x$, and that they align properly with
    the $\sigma_k(x)$'s to form an infix of some power of $x$, except for the
    last one. In particular, $w[\vec{n_i}] \in \InfPeriodChain{x} u_{\ell+1}$,
    but also, every other choice of $\vec{n}$ will lead to a word in
    $\InfPeriodChain{x} u_{\ell+1}$, because the alignment constraints are
    stable under pumping.

    In the case of two iterated words, the reasoning is similar, distinguishing
    between the $v_i$'s that are occurring before and after the junction of the
    two iterated words.

    When $k = 1$, the situation is a bit more specific since we only have two
    cases: either $w_i \infleq u_1 v_1^{n_j}$ or $w_i \infleq v_1^{n_j} u_2$,
    and we conclude with an identical reasoning.
\end{proofof}

\begin{proofof}{bounded-language:lem}
    Let $w_1, \dots, w_n$ be such that
    $L \subseteq w_1^* \cdots w_n^*$.
    Let us define $m \defined \max \setof{\card{w_i}}{1 \leq i \leq n}$

      Let $w[\vec{k}] \defined w_1^{k_1} \cdots w_n^{k_n}$ be a map from $\Nat^k$
      to $\Sigma^*$. We are interested in the intersection of the image of $w$
      with $L$. Let us assume for instance that for all $\vec{k} \in \Nat^n$,
      there exists $\vec{\ell} \geq \vec{k}$ such that $w[\vec{\ell}] \in L$.
      Then, leveraging \cref{pumping-periods:lem}, we conclude that there exists
      $x,y$ of size at most $\max\setof{\card{w_i}}{1 \leq i \leq n}$ such that
      $w[\vec{k}] \in \InfPeriodChain{x} \cup \InfPeriodChain{x}
      \InfPeriodChain{y}$, and we conclude that $L \subseteq \InfPeriodChain{x}
      \cup \InfPeriodChain{x} \InfPeriodChain{y}$.

      Now, it may be the case that one cannot simultaneously assume that two
      component of the vector $\vec{k}$ are unbounded. In general, given a set $S
      \subseteq \set{1, \dots, n}$ of indices, we say that $S$ is admissible if
      there exists a bound $N_0$ such that for all $\vec{b} \in \Nat^S$, there
      exists a vector $\vec{k} \in \Nat^n$, such that $\vec{k}$ is greater than
      $\vec{b}$ on the $S$ components, and the other components are below the
      bound $N_0$. The language of an admissible set $S$ is the set of words
      obtained by repeating $w_i$ at most $N_0$ times if it is not in $S$
      ($w_i^{\leq N_0}$) and arbitrarily many times otherwise ($w_i^*$).
      Note that $L \subseteq \bigcup_{S \text{ admissible }} L(S)$.

      Now, admissible languages are ready to be pumped according to
      \cref{pumping-periods:lem}. For every admissible language,
      the size of a word that is not iterated is at most
      $N_0 \times m$ by definition, and we conclude that:
      \begin{equation}
          \label{bounded-language:eq}
          L \subseteq 
          \bigcup_{x,y \in \Sigma^{\leq n}}
          \bigcup_{u \in \Sigma^{\leq m \times N_0}}
          \InfPeriodChain{x} u \InfPeriodChain{y}
          \cup
          \InfPeriodChain{x} u
          \cup
          u \InfPeriodChain{x}
          \quad .
      \end{equation}
  \end{proofof}

\clearpage
\section{Proofs for Section~\ref{infixes-dwclosed:sec}}

\begin{proofof}{bounded-wqo-dwclosed:cor}
    Because $L \subseteq \dwset[\infleq]{L}$, the right-to-left implication
    is trivial.
    For the left-to-right implication, let us assume that $L$ is a
    \kl{well-quasi-ordered} language for the \kl{infix relation}.
    Then $L$ is included in a finite union 
    of products of \kl{chains} for the \kl{prefix} and \kl{suffix} relations
    thanks to
    \cref{bounded-language:thm}:
    \begin{equation*}
        L \subseteq \bigcup_{i = 1}^n S_i \cdot P_i \quad .
    \end{equation*}
    Remark that if $S_i$ is a \kl{chain} for the \kl{suffix relation}
    and $P_i$ is a \kl{chain} for the \kl{prefix relation},
    then 
    \begin{equation*}
      \dwset[\infleq]{(S_i \cdot P_i)} = (\dwset[\suffleq]{S_i}) \cdot (\dwset[\prefleq]{P_i})
        \quad .
    \end{equation*}
    Indeed, any \kl{infix} of a word in $S_i P_i$ can be split into
    a \kl{suffix} of a word in $S_i$ and a \kl{prefix} of a word in $P_i$.
    Conversely, any such concatenations are \kl{infixes} of a word in $S_i P_i$.


    As a consequence, we conclude that $\dwset[\infleq]{L}$ is itself included
    in a finite union of products of \kl{chains}.
    Furthermore, by definition of \kl{bounded languages},
    $\dwset[\infleq]{L}$ is also a \kl{bounded language}.
    Hence, it is \kl{well-quasi-ordered} by the \kl{infix relation} 
    via
    \cref{bounded-language:thm}.
\end{proofof}



\begin{proofof}{bi-infinite:lem}
    Let us assume that $L$ is infinite. The case when it is finite 
    is similar, but will result in a finite word.
    \todo{aliaume: do we need wqo here? the proof
      should go through without it: the sequence 
      $u_i$ is already increasing for infix}

    Because the alphabet $\Sigma$ is finite, we can enumerate the words of $L$
    as $\seqof{w_i}[i \in \Nat]$. From $\seqof{w_i}[i \in \Nat]$, we construct a sequence $\seqof{u_i}[i \in \Nat]$ by induction
    as follows: $u_0 = w_0$, and $u_{i+1}$ is a word that contains $u_i$ and
    $w_i$, which exists in $L$ because $L$ is \kl(subset){directed}. Since $L$ is
    \kl{well-quasi-ordered}, one can extract an infinite set of indices $I
    \subseteq \Nat$ such that $u_i \infleq u_{j}$ for all $i \leq j \in I$.

    We can build a word $w$ as the limit of the sequence $\seqof{u_i}[i \in
    I]$. This word is infinite or bi-infinite, and contains as infixes all the
    words $u_i$ for $i \in I$. Because every word of $L$ is an infix of every
    $u_i$ for a large enough $I$, one concludes that $L$ is contained in the
    set of finite infixes of $w$. Conversely, every finite infix of $w$ is 
    an infix of some $u_i$ by definition of the limit construction, hence
    belongs to $L$ since $u_i \in L$ and $L$ is \kl{downwards closed}.
\end{proofof}

\begin{proofof}{ultimately-uniformly-recurrent:lem}

    Assume that $w$ is \kl{ultimately uniformly recurrent}. Consider a sequence
    of words $\seqof{w_i}[i \in \Nat]$ that are finite \kl{infixes} of $w$. Because $w$ is
    \kl{ultimately uniformly recurrent}, there exists a bound $N_0$ such that
    $w_{\geq N_0}$ is \kl{uniformly recurrent}. Let $i < N_0$, we claim that,
    without loss of generality, only finitely many words in the sequence
    $\seqof{w_i}[i \in \Nat]$ can be found starting at the position $i$ in $w$. Indeed, if
    it is not the case, then we have an infinite subsequence of words that are
    all comparable for the \kl{infix relation}, and therefore a \kl{good
    sequence}, because the \kl{infix relation} is \kl{well-founded}. We can
    therefore assume that all words in the sequence $\seqof{w_i}[i \in \Nat]$ are such that
    they start at a position $i \geq N_0$. But then they are all finite
    \kl{infixes} of $w_{\geq N_0}$, which is a \kl{uniformly recurrent} word,
    whose set of finite \kl{infixes} is \kl{well-quasi-ordered}
    (\cref{uniformly-recurrent:lem}).

    Conversely, assume that the set of finite infixes of $w$ is
    \kl{well-quasi-ordered}. Let us write $\mathsf{Rec}(w)$ the set of finite
    \kl{infixes} of $w$ that appear infinitely often. We can similarly define
    $\mathsf{Rec}(w_{\geq i})$ for any (infinite) suffix of $w$. The sequence
    $R_i \defined \mathsf{Rec}(w_{\geq i})$ is a descending sequence of \kl{downwards
    closed} sets of finite words, included in the set of finite infixes of $w$
    by definition. Because the latter is \kl{well-quasi-ordered}, there exists
    an $N_0 \in \Nat$, such that $\bigcap_{i \in \Nat} R_i = R_{N_0}$.
    Now, consider $v \defined w_{\geq N_0}$. By construction, 
    every finite infix of $v$ 
    appears infinitely often in $v$. 
    Given
    some finite infix $u \infleq v$, we 
    there exists a bound $N_u$
    on the distance
    between two consecutive occurrences of $u$ in $v$.
    Indeed, if it is not the case, then there exists an infinite sequence
    $\seqof{u x_i u}[i \in \Nat]$ of infixes of $v$, such that $x_i$ is a word
    of size $\geq i$
    and no shorter word $u y u$ is an infix of $u x_i u$.
    Because the finite infixes of $w$ (hence, of $v$) are \kl{well-quasi-ordered},
    one can extract an infinite set of indices $I \subseteq \Nat$
    such that $u x_i u \infleq u x_{j} u$ for all $i \leq j \in I$.
    In particular, $u x_i u \infleq u x_{j} u$ for some $j > |x_i|$, 
    which contradicts the fact that $u x_j u$ coded two consecutive
    occurrences of $u$ in $v$.

    We have shown that for every finite infix $u$ of $v$, there exists a bound
    $N_u$ such that every two occurrences of $u$ in $v$ start at distance at
    most $N_u$. In particular, there exists a bound $M_u$ such that every infix
    of $v$ of size at least $M_u$ contains $u$. We have proven that
    $v$ is \kl{uniformly recurrent}, hence that $w$ is \kl{ultimately uniformly
    recurrent}.
\end{proofof}


\begin{proofof}{bi-infinite-uur:lem}
  Given a bi-infinite word $w \in \Sigma^{\Rel}$, we can consider $w_+ \in
\Sigma^\Nat$ and $w_- \in \Sigma^\Nat$ the two infinite words obtained as
follows: for all $i \in \Nat$, $(w_+)_i = w(i)$ and $(w_-)_i = w(-i)$. Note
that the two share the letter at position $0$.

    Assume that $w_+$ and $w_-$ are \kl{ultimately uniformly recurrent}. Let us
    write $\infset{w}$ the set of finite infixes of $w$. Consider an infinite
    sequence of words $\seqof{u_i}[i \in \Nat]$ in $\infset{w}$. If there is an
    infinite subsequence of words that are all in $\infset{w_+}$, then there
    exists an increasing pair of indices $i < j$ such that $u_i \infleq
    u_j$ because \cref{uniformly-recurrent:lem} applies to $w_+$. Similarly, if
    there is an infinite subsequence of words that are all in $\infset{w_-}$,
    then there exists an increasing pair of indices $i < j$ such that $u_i
    \infleq u_j$ because \cref{uniformly-recurrent:lem} applies to $w_-$ (and
    the \kl{infix relation} is compatible with mirroring). Otherwise, one can
    assume without loss of generality that all words in the sequence have a
    starting position in $w_-$ and an ending position in $w_+$. In this case,
    let us write $(k_i,l_i) \in \Nat^2$ the pair of indices such that $u_i$ is the infix
    of $w$ that starts at position $-k_i$ of $w$ (i.e., $k_i$ of $w_-$) and
    ends at position $l_i$ of $w$ (i.e., $l_i$ of $w_+$).
    Because $\Nat^2$ is a \kl{well-quasi-ordering} with the product ordering,
    there exists $i < j$ such that $k_i \leq k_j$ and $l_i \leq l_j$, 
    in particular, $u_i \infleq u_j$. We have proven that every infinite
    sequence of words in $\infset{w}$ is \kl(wqo){good}, hence $\infset{w}$ is
    \kl{well-quasi-ordered}.

    Conversely, assume that $\infset{w}$ is \kl{well-quasi-ordered}. In
    particular, the subset $\infset{w_+} \subseteq \infset{w}$ is \kl{well-quasi-ordered}.
    Similarly, $\infset{w_-}$ is \kl{well-quasi-ordered} because the \kl{infix
    relation} is compatible with mirroring. Applying
    \cref{ultimately-uniformly-recurrent:lem}, we conclude that both are
    \kl{ultimately uniformly recurrent} words.

\end{proofof}


\begin{proofof}{from-bi-to-single:lem}
  Given a bi-infinite word $w \in \Sigma^{\Rel}$, recall that we can consider $w_+ \in
\Sigma^\Nat$ and $w_- \in \Sigma^\Nat$ the two infinite words obtained as
follows: for all $i \in \Nat$, $(w_+)_i = w(i)$ and $(w_-)_i = w(-i)$. Note
that the two share the letter at position $0$.

    To obtain the upper bound of $\omegaOrd\cdot 3$, we can consider the same
    argument as for \cref{small-ordinal-invariants:lem}. We let $N_0$ be such
    that $w_{\geq N_0}$ and $(w_-)_{\geq N_0}$ are \kl{uniformly recurrent}
    words. In any sequence of incomparable elements of $\infset{w}$, there are
    less than $N_0^2$ elements that are found in $(w_{< N_0})_{> -N_0}$. Then,
    one has to pick a finite \kl{infix} in either $w_{\geq N_0}$ or $w_{\leq
    -N_0}$. Because of \cref{small-ordinal-invariants:lem}, any sequence of
    incomparable elements of these two infinite words has length bounded based
    on the choice of the first element of that sequence. This means that the
    \kl{ordinal width} of $\infset{w}$ is at most $\omegaOrd + \omegaOrd +
    N_0^2$. We conclude that $\oWidth{\infset{w}} < \omegaOrd \cdot 3$.

  Let us briefly argue that the bound is tight. Indeed, one can
  construct a bi-infinite word $w$ by concatenating a reversed \kl{Thue-Morse
  sequence} on a binary alphabet $\set{a,b}$, a finite antichain of arbitrarily
  large size over a distinct alphabet $\set{c,d}$, and then a \kl{Thue-Morse
  sequence} on a binary alphabet $\set{e,f}$. The \kl{ordinal width} of the set
  of \kl{infixes} of $w$ is then at least $\omegaOrd \cdot 2 + K$, where $K$ is the
  size of the chosen antichain, following the same argument as in the proof of
  \cref{small-ordinal-invariants:lem}, using \cref{thue-morse-ordinal:lemma}.
\end{proofof}

\begin{lemma}
	\label{automatic-uur:lem}
	\proofref{automatic-uur:lem}
	Given an \kl{automatic sequence} $w \in \Sigma^{\Nat}$, one can decide
	whether it is \kl{ultimately uniformly recurrent}.
\end{lemma}

\begin{proofof}{automatic-uur:lem}
	We can rewrite this as a question on the \kl{automatic sequence} $w$
	as follows:
	\begin{align*}
		&\exists N_0,                   &   \text{ultimately} \\
		&\forall i_s \geq N_0,          &   \text{for every infix (start) } u \\
		&\forall i_e > i_s,             &   \text{for every infix (end) }   u \\
		&\exists k \geq 1,              &   \text{there exists a bound} \\
		&\forall j_s \geq N_0,          &   \text{for every other infix (start) } v \\
		&\forall j_e \geq j_s + k,      &   \text{of size at least $k$} \\
		&\exists l \geq 0,              &   \text{there exists a position in } v \\
		&\forall 0 \leq m < i_e - i_s,  &   \text{where } u \text{ can be found} \\
		&j_s + m + l < j_e \land
		w(i_s + m) = w(j_s + m + l) \quad .
	\end{align*}
	Because $w$ is computable by a finite automaton, one can reduce the above
	formula to a regular language, for which it suffices to check emptiness, which
	is decidable.
\end{proofof}


\begin{proofof}{small-ordinal-invariants:lem}
	Let $N_0$ be a bound such that $w_{\geq N_0}$ is \kl{uniformly recurrent}.
	Let us write $\infset{w}$ the set of finite infixes of $w$.
	We prove that $\oWidth{\infset{w}} \leq \omegaOrd + N_0$.
	Let $u_1 \infleq w$ be a finite word. 
	
	If $u_1$ is an \kl{infix} of $w_{\geq N_0}$, then there exists $k \geq 1$
	such that $u_1$ is an \kl{infix} of every word of size at least $k$. In
	particular, there is finite bound on the length of every sequence of
	incomparable elements starting with $u_1$. We conclude in particular that
	$\infset{w} \setminus \upset{u_1}$ has a finite \kl{ordinal width}.
	
	Otherwise, $u_1$ can only be found \emph{before} $N_0$. In this case, we
	consider a second element of a \kl{bad sequence} $u_2 \infleq w$, which is
	incomparable with $u_1$ for the \kl{infix relation}. If $u_2$ is an
	\kl{infix} of $w_{\geq N_0}$, then we can conclude as before. Otherwise,
	notice that $u_1$ and $u_2$ cannot start at the same position in $w$
	(because they are incomparable). Continuing this argument, we conclude that
	there are at most $N_0$ elements starting before $N_0$
	at the start of any sequence of
	incomparable elements in $\infset{w}$. We conclude that
	$\oWidth{\infset{w}} \leq \omegaOrd + N_0$.
	
	Let us now justify that this bound is tight.
	The \kl{Thue-Morse sequence} over a binary
	alphabet $\set{a,b}$ has \kl{ordinal width} $\omegaOrd$
	from \cref{thue-morse-ordinal:lemma}.
	Given a number $N_0
	\in \Nat$, one can construct an arbitrarily long \kl{antichain} of words for
	the \kl{infix relation} by using a new letter $c$. When concatenating this
	(finite) antichain as a prefix of the \kl{Thue-Morse sequence}, one obtains a
	new (infinite) word $w$. It is clear that the \kl{ordinal width} of
	$\infset{w}$ is now at least $\omegaOrd + N_0$.
\end{proofof}


\begin{proofof}{small-ordinal-invariants:thm}
    It is always true that the \kl{ordinal height} of a language over a finite
    alphabet is at most $\omegaOrd$. Let us now consider a
    \kl{well-quasi-ordered} language $L$ that is \kl{downwards closed} for the
    \kl{infix relation}. Applying 
    \cref{dw-closed-wqo-charac:thm}, we can write $L = \bigcup_{i = 1}^n L_i$ where
    each $L_i$ is the set of finite \kl{infixes} of a finite, infinite or
    bi-infinite \kl{ultimately uniformly recurrent} word $w_i$.
   We can then
    directly conclude that $\oWidth{L_i}$ less than $\omegaOrd$ (in the case of
    a finite word), less than $\omegaOrd \cdot 2$ (in the case of an infinite
    word thanks to \cref{small-ordinal-invariants:lem}), or less than $3 \cdot
    \omegaOrd$ (in the case of a bi-infinite word, thanks to
    \cref{from-bi-to-single:lem}). In any case,
    we have the bound $\oWidth{L_i} < \omegaOrd \cdot 3$.

    Now, $\oWidth{L} \leq \sum_{i = 1}^n \oWidth{L_i} < \omegaOrd \cdot 3 <
    \omegaOrd^2$. Finally, the inequality $\oType{L} \leq \oWidth{L} \oComProd
    \oHeight{L} < \omega \oComProd \omega^2 = \omegaOrd^3$ allows us to
    conclude.

    The tightness of the bounds is a direct consequence of
    \cref{from-bi-to-single:lem}, and by considering a finite union of 
    these examples over disjoint alphabets (or even, by considering a binary 
    alphabet and using unambiguous codes to separate the different components).
\end{proofof}


\clearpage
\section{Proofs for Section~\ref{infixes-amalgamation:sec}}

\begin{figure}
    \centering
    \includestandalone[width=\linewidth]{fig/gap-word-embedding-standalone}
    \caption{The \kl{gap words} resulting from a \kl{subword embedding} between two 
    finite words.}
    \label{gap-word-embedding:fig}
\end{figure}

\begin{figure}
    \centering
    \includestandalone[width=\linewidth]{fig/run-amalgamation-standalone}
    \caption{We illustrate how 
        embeddings $f$ and $g$ between runs of an
        \kl{amalgamation system} can be glued
        together, seen on their canonical decomposition.
    }
    \label{amalgamation-runs:fig}
\end{figure}


For this paper to be self-contained, we will also recall how runs of a finite
state automaton can be understood as an \kl{amalgamation system}.

\begin{example}[{\cite[Section 3.2]{ASZZ24}}]
  \label{automaton-amalgamation:example}
    Let $A = (Q, \delta, q_0, F)$ be a finite state automaton over a finite
    alphabet $\Sigma$. Let $\Delta$ be the set of transitions $(q_1, a, q_2)
    \in Q \times \Sigma \times Q$,
    and $R \subseteq \Delta^*$ be the set of 
    words over transitions that start with the initial state $q_0$,
    end in a final state $q_f \in F$, and such that the end state of a
    letter is the start state of the following one.
    The canonical decomposition $\canrun$
    is defined as a morphism from $\Delta^*$ to $\Sigma^*$
    that maps $(q,a,p)$ to $a$. 
    Because of the one-to-one correspondence of steps of a run $\rho$ and letters in its \kl{canonical decomposition}, 
    we may treat the two interchangeably.
    Finally, given two runs $\rho$ and $\sigma$ of the automaton,
    we say that an embedding $f \in \HigEmb(\canrun(\rho), \canrun(\sigma))$
    belongs to $E(\rho,\sigma)$ when
    $f$ is also defining an embedding from $\rho$ to $\sigma$ as words in $\Delta^*$.

    The system $(\Sigma, R, E, \canrun)$ is an \kl{amalgamation system},
    whose language is precisely the language of words recognized
    by the automaton $A$.
\end{example}
\begin{proof}
    By definition, the embeddings inside $E(\rho,\sigma)$ are in
    of $\HigEmb(\canrun(\rho), \canrun(\sigma))$, and they compose properly.
    Because $\Delta = Q \times \Sigma \times Q$ is finite, it is 
    a \kl{well-quasi-ordering} when equipped with the equality relation, and 
    we conclude that $\Delta^*$ with $\higleq$ is a \kl{well-quasi-order}
    according to Higmanâs Lemma \cite{HIG52}.
    
    Let us now move to proving that the system satisfies the amalgamation
    property. Given three runs $\rho,\sigma,\tau \in R$, and two embeddings $f \in E(\rho,\sigma)$
    and $g \in E(\rho,\tau)$, we want to construct an amalgamated run $\sigma \vee \tau$.
    Because letters in the run $\rho$ respect the transitions of the automaton
    (i.e., if the letter $i$ ends in state $q$, then the letter $i+1$ starts in
    state $q$), then the \kl{gap word} at position $i$ starts in state $q$ and
    ends in state $q$ too. This means that for both embeddings
    $f$ and $g$, the \kl{gap words} are read by the automaton by looping
    on a state. In particular, these loops can be taken in any order
    and continue to represent a valid run. That is, we can even select
    the order of concatenation in the amalgamation for \emph{all} 
    $0 \leq i \leq \card{\canrun(\rho)}$ and not just for one separately.

    We conclude by remarking that 
    the language of this amalgamation system is
    the set of $\yieldrun(R)$, 
    because $R$ is the set of valid runs of the automaton,
    and $\yieldrun(\rho)$ is the word read along a run $\rho$.
\end{proof}



\begin{proofof}{gap-words-prefix-ordered:lem}
	Write $u$ for $\GapWord{f}{\ell}$ and $v$ for $\GapWord{g}{\ell}$. 
	We may assume that both $u$ and $v$ are non-empty, as otherwise the lemma holds trivially.
	Then, for all $k \in \Nat$, there exists a run with canonical decomposition
	$$
	w_k = L_0 a_1 \cdots a_n L_n,
	$$
	where $L_i \in \set{vv u^k, vu^kv, u^k vv}$ and specifically $L_\ell = vu^kv$.
	
	From \cref{pumping-periods:lem}, we may conclude that there are a finite number of words $x, y,$ and $w$ 
	such that each $w_k$ is contained in a language 
	$\InfPeriodChain{x}w\InfPeriodChain{y}$.
	
	As there is an infinite number of words $w_k$, 
	we may fix $x, y,$ and $w$ and an infinite subset $I \subseteq \Nat$ 
	such that $\set{w_i \mid i \in I} \subseteq \InfPeriodChain{x}w\InfPeriodChain{y}$. 
	This implies that either for infinitely many $m \in \Nat$, $u^m v \in \InfPeriodChain{y}$ 
	or for infinitely many $m$, $v u^m \in \InfPeriodChain{x}$. 
	
	In either case, we may conclude that either $u \infleq v$ or $v \infleq u$: Let $m, n \in \Nat$
	such that $m < n$ and $u^m v, u^n v \in \InfPeriodChain{y}$ (the case for $v u^m$ and $v u^n$ 
	proceeding analogously). Without loss of generality, assume that $\card{u^m}$ and $\card{u^n}$ are
	multiples of $\card{y}$. We therefore find $p \prefleq y, s \suffleq y$ such that $u^m, u^n \in sy^*p$, 
	ergo $ps = y$.
	In other words, we can write $u^m = (sp)^{m'}, u^n = (sp)^{n'}$. As $u^mv \in \InfPeriodChain{y}$, it 
	follows that $v$ is a prefix of some word in $(sp)^*$. Hence either $v$ is a prefix of $u$ or $u$ vice versa.
\end{proofof}



\begin{proofof}{dwclosed-infixes-wqo:lem}
    It is clear that \cref{dwci-reg:item} $\Rightarrow$ \cref{dwci-aml:item}
    because regular languages are recognized by finite automata, and finite
    automata are a particular case of \kl{amalgamation systems}.
    The implication \cref{dwci-aml:item} $\Rightarrow$ \cref{dwci-bod:item}
    is the content of \cref{infix-amalgamation:thm}.
    The implication \cref{dwci-bod:item} $\Rightarrow$ \cref{dwci-uoc:item}
    is \cref{bounded-language:lem}.
    Finally, the implication \cref{dwci-uoc:item} $\Rightarrow$ \cref{dwci-reg:item}
    is simply because a \kl{downwards closed} language 
    that is a finite union of products of \kl{chains} is a regular language.

    Indeed, assume that
    $L$ is \kl{downwards closed} and included in a finite union of sets of the form
    $\InfPeriodChain{x} u \InfPeriodChain{y}$ where $x,y,u$ are possibly empty words.
    We can assume without loss of generality that
    for every $n$, $x^n u y^n$ is in $L$, otherwise, we have a bound on the maximal $n$ such that
    $x^n u y^n$ is in $L$, and we can increase the number of languages in the union, replacing $x$ or $y$
    with the empty word as necessary.
    Let us write $L' \defined \bigcup_{i = 1}^k x_i^* u_i y_i^*$. Then, $L'
    \subseteq L$ by construction. Furthermore, $L \subseteq \dwset{L'}$, also
    by construction. Finally, we conclude that $L = \dwset{L'}$ because $L$ is
    \kl{downwards closed}. Now, because $L'$ is a \kl{regular language}, and 
    \kl{regular languages} are closed under \kl{downwards closure}, we conclude
    that $L$ is a \kl{regular language}.
\end{proofof}


\begin{proofof}{infix-amalgamation:thm}
    Assume that $L$ is \kl{well-quasi-ordered} by the \kl{infix relation},
    and obtained by an \kl{amalgamation system}
    $(\Sigma, R, E, \canrun)$.

    Let us consider the set $M$ of minimal runs for the relation $\leq_E$,
    which is finite because the latter is a \kl{well-quasi-ordering}. 
    By \cref{gap-words-prefix-ordered:lem}, we know that for each minimal run $\rho \in M$,
    each gap language $\GapLanguage{\rho}{i}$ of $\rho$ is totally ordered by $\infleq$.
    Adapting the proof of language boundedness from \cite[Section 4.2]{ASZZ24}, we may conclude that $\GapLanguage{\rho}{i} \subseteq \InfPeriodChain{w}$ for some $w \in \GapLanguage{\rho}{i}$.
    As $\InfPeriodChain{w}$ is language bounded and this property is stable under subsets, concatenation and finite union,
    we can conclude that $L$ is bounded as well.
\end{proofof}

\begin{proofof}{infix-wqo-is-emptiness:thm}
	We first show \cref{emptiness-decidable} $\Rightarrow$ \cref{wqo-infix-decidable}. We aim to make the inclusion test of \cref{bounded-language:eq} of \cref{bounded-language:thm} effective. 
	Let $R(n,m,N_0) \defined \bigcup_{x,y \in \Sigma^{\leq n}} \bigcup_{u \in
    \Sigma^{\leq m \times N_0}} \InfPeriodChain{x} u \InfPeriodChain{y} \cup
    \InfPeriodChain{x}u \cup u\InfPeriodChain{x}$. For any concrete values of
    the bounds $n$, $m$, and $N_0$, this language is regular. The map $L
    \mapsto L \cap \Sigma^* \setminus R(n,m,N_0)$  is a \kl{rational
    transduction} because $\Sigma^* \setminus R(n,m,N_0)$ is regular. Since
    $\mathcal{C}$ is \kl{closed under rational transductions}, we can therefore
    reduce the inclusion to emptiness of this language. However, we need to
    find these bounds first.
	
    To determine values for $n$ and $m$, we first test if $L$ is
    \kl(language){bounded}. Since emptiness is decidable, we can apply the
    algorithm in~\cite[Section 4.2]{ASZZ24} to decide if $L$ is
    \kl(language){bounded}. If $L$ is \kl(language){bounded}, this algorithm
    yields words $w_1, \ldots w_n$ such that $L \subseteq w_1^* \cdots w_n^*$
    and therefore yields also the bounds in questions: $n$ is the number of
    words, and $m$ is the maximal length of a word $w_i$ where $1 \leq i \leq
    n$. If $L$ is not bounded, then $L$ cannot be \kl{well-quasi-ordered} by
    the \kl{infix relation} because of \cref{infix-amalgamation:thm} and we
    immediately return false.
	
    To determine the value for $N_0$, we then compute the downward closure (with respect to subwords) of $L$. 
    This is effective and yields a finite-state automaton. 
    Recall that $N_0$ is the maximum number of repetitions of a word $w_i$ that can not be iterated arbitrarily often. 
    This value is therefore bounded above by the length of the longest simple path in this automaton.
    
    \cref{wqo-infix-decidable} $\Rightarrow$
    \cref{wqo-prefix-decidable}. We just consider the transduction $f$
    that maps every word $w$ to $\# w$ where $\# $ is a fresh symbol. Then, for
    any language $L \in \mathcal C$, $L$ is \kl{well-quasi-ordered} by
    \kl{prefix} if and only if $f(L)$ is \kl{well-quasi-ordered} by \kl{infix}.
	
    \cref{wqo-prefix-decidable} $\Rightarrow$
    \cref{emptiness-decidable}. 
	We 
	consider the transduction $R \defined \Sigma^* \times \set{a, b}^*$. Then 
	for any language $L \in \mathcal C$,
    the image of $L$ through $R$ is \kl{well-quasi-ordered}
    by \kl{prefix} if and only if $L$ is empty.
\end{proofof}
