% LTeX: language=en-GB 
\section{Prefixes and Suffixes}
\label{prefixes:sec}

In this section, we study the well-quasi-ordering of languages under the prefix
relation. A word $u$ is a \intro{prefix} of a word $w$ if there exists a word
$v$ such that $w = uv$. We denote this relation by $u \intro*\prefleq w$.
Similarly, a word $u$ is a \intro{suffix} of a word $w$ if there exists a word
$v$ such that $w = vu$. We denote this relation by $u \intro*\suffleq w$. Let
us immediately remark that the map $u \mapsto u^R$ that reverses a word is an
order-bijection between $(X^*, \prefleq)$ and $(X^*, \suffleq)$. Therefore, we
will focus on the prefix relation in the rest of this section.


Let us briefly restate the fact that some (even regular) languages 
are not well-quasi-ordered by the prefix relation.

\begin{example}
    The set $L = \setof{a^nb}{n \in \Nat} \subseteq \set{a,b}^*$ is an infinite \kl{antichain} for the
    \kl{prefix relation}.
\end{example}

In order to characterize the existence of infinite antichains for the prefix
relation, we will introduce the following tree construction that
will be useful in the rest of this section.

\begin{definition}
    The \intro{tree of prefixes} over a finite alphabet $\Sigma$
    is the infinite tree $T$ whose nodes are the words of $\Sigma^*$, and
    such that the children of a word $w$ are the words $wa$ for all $a \in
    \Sigma$. 
\end{definition}

\begin{figure}
    \centering
    \caption{The tree of prefixes over the alphabet $\set{a,b}$,
        with an \kl{antichain} in red, and
        an \kl{antichain branch} in blue.}
\end{figure}

Because the alphabet $\Sigma$ is assumed to be finite, the \kl{tree of
prefixes} is finitely branching. Let us now observe how \kl{antichains} in the
prefix relation can be witnessed by infinite branches in the \kl{tree of
prefixes}.

\begin{definition}
    An \intro{antichain branch} for a language $L$ is an infinite 
    branch $B$ of the \kl{tree of prefixes} such that from every point of the branch, 
    one can reach a word of $L$ that is not in the branch.
\end{definition}

It is clear that an \kl{antichain branch} for a language $L$ yields an infinite
antichain, and the converse is quite easy to prove. Because the notion of
antichain branch is \kl{$\MSO$-definable} whenever $L$ is regular, we
immediately obtain decidability as a corollary of this lemma.

\begin{lemma}
    Let $L \subseteq \Sigma^*$ be a language. Then, $L$ contains an infinite
    \kl{antichain} if and only if there exists an \kl{antichain branch} for $L$.
\end{lemma}
\begin{proof}
    Assume that $L$ contains an \kl{antichain branch}. Let us construct an
    infinite \kl{antichain} as follows. We start with a set $A_0 \defined
    \emptyset$ and a node $v_0$ at the root of the tree. At step $i$, we
    consider a word $w_i$ such that $v_i$ is a \kl{prefix} of $w_i$, and $w_i
    \in L \setminus B$, which exists by definition of \kl{antichain branches}.
    We then set $A_{i+1} \defined A_i \cup \set{w_i}$. To compute $v_{i+1}$, we
    consider the largest prefix of $w_i$ that belongs to $B$, and set $v_{i+1}$
    to be the successor of this prefix in $B$. By an immediate induction, we
    conclude that for all $i \in \Nat$, $A_i$ is an \kl{antichain}, and that
    $v_i$ is a node in the \kl{antichain branch} $B$ such that $v_i$ is not a
    prefix of any word in $A_i$. 

    Conversely, assume that $L$ contains an infinite \kl{antichain} $A$. Let us
    construct an \kl{antichain branch}. Let us consider the subtree of the
    \kl{tree of prefixes} that consists in words that are \kl{prefixes} of
    words in $A$. This subtree is infinite, and by KÃ¶nig's lemma, it contains
    an infinite branch. By definition this is an \kl{antichain branch}.
\end{proof}

\begin{corollary}
    If $L$ is regular, then the existence of an infinite antichain is decidable.
\end{corollary}
\begin{proof}
    If $L$ is regular, then it is \kl{$\MSO$-definable}, and there 
    exists a formula $\varphi(x)$ in \kl{$\MSO$} that selects nodes 
    of the \kl{tree of prefixes} that belong to $L$. Now, to decide whether there
    exists an \kl{antichain branch} for $L$, we can simply check whether
    the following formula is satisfied:
    \begin{equation*}
        \exists B. 
        B \text{ is a branch } \land
        \forall x \in B, \exists y. y \text{ is a child of } x \land \varphi(y) \land y \not\in B
        \quad .
    \end{equation*}
    Because the above formula is an $\MSO$-formula over the infinite
    binary tree, whether it is satisfied is decidable.
    \textbf{TODO: cite}.
\end{proof}

Let us now go further and fully characterize languages $L$ such that the
prefix relation is well-quasi-ordered, even without any restriction on the
decidability of $L$ itself. Let us remark that finite unions of \kl{chains} are
always \kl{well-quasi-ordered} by the \kl{prefix relation} because they lack
infinite \kl{antichains} by definition. The following theorem states that this
is the only possible reason for a language $L$ to be \kl{well-quasi-ordered} by
the \kl{prefix relation}.

\begin{theorem}
    \label{prefixes:thm}
    A language $L \subseteq \Sigma^*$ is \kl{well-quasi-ordered} by the
    \kl{prefix relation} if and only if $L$ is a union of \kl{chains}.
\end{theorem}
\begin{proof}
    Assume that $L$ is a finite union of \kl{chains}.
    Because the \kl{prefix relation} is \kl{well-founded},
    and that finite unions of \kl{chains} have finite \kl{antichains},
    we conclude that $L$ is \kl{well-quasi-ordered}.

    Conversely, assume that $L$ is \kl{well-quasi-ordered} by the \kl{prefix
    relation}. Let us define $S$ the set of words $w$ such that there exists
    two words $wu$ and $wv$ both in $L$ that are not comparable for the
    \kl{prefix relation}. Assume by contradiction that $S$ is infinite.
    Then, $S$ equipped with the \kl{prefix relation} is an infinite
    tree with finite branching, and therefore contains an infinite
    branch, which is by definition an \kl{antichain branch} for $L$.
    This contradicts the assumption that $L$ is \kl{well-quasi-ordered}.
    Now, consider $w$ be a maximal element for the \kl{prefix ordering}
    in $S$. By definition, all words in $L$ that contain $w$ as a prefix
    must be comparable for the \kl{prefix relation}. Therefore
    $\upset[\prefleq]{w} \cap L$ is a \kl{chain} for the \kl{prefix relation}.
    In particular, letting $S_{\max}$ be the set of all maximal elements
    of $S$,
    we conclude that 
    \begin{equation*}
        L \subseteq S \cup \bigcup_{w \in S_{\max}} \upset[\prefleq]{w} \cap L
        \quad .
    \end{equation*}
    Hence, that $L$ is finite union of \kl{chains}.
\end{proof}

As an immediate consequence, we have a very fine-grained understanding of the
\kl{ordinal invariants} of such \kl{well-quasi-ordered} languages, which can be
leveraged in bounding the complexity of algorithms working on such languages.

\begin{corollary}
    Let $L \subseteq \Sigma^*$ be an infinite language that is \kl{well-quasi-ordered} by
    the \kl{prefix relation}. Then, there exists finite numbers $k,\ell \in \Nat$ such that
    the
    \kl{maximal order type} of $L$ is $k \cdot \omega$,
    the \kl{ordinal height} of $L$ is $\omega$, and its
    \kl{ordinal width} is $\ell$.
\end{corollary}
\begin{proof}
    \textbf{todo.}
\end{proof}

Let us conclude by noting that it is unsurprisingly not possible to decide
whether a decidable language is \kl{well-quasi-ordered} by the \kl{prefix
relation}.

\begin{lemma}
    todo.
\end{lemma}
